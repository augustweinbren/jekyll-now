---
layout: post
title: Air Cycle, a bicycle-mounted air pollution sensor and monitor 
published: false
---

Note: the codebase can found in [the Air Cycle GitHub Repository](https://github.com/augustweinbren/air-cycle).

## Introduction

Air pollution is a highly deadly problem in urban environments. Outdoor air pollution, specifically particulate matter (PM), was responsible for 4.2 million deaths globally in 2016 (World Health Organization 2016). London in particular is frequently found to exceed the PM 2.5 (particulates of diameter 2.5 micrometers or smaller) limits set by the World Health Organization (IQAir 2021). However, particulate matter concentrations vary significantly between streets (LondonAir, 2021). As data from the London Air Quality Network does not include measurements on smaller streets (which comprise the bulk of my cycle commute), it is difficult to use existing data to quantify the particulate matter I am exposed to while bicycling to UCL on a daily basis.

In order to resolve this data gap, I have built a device that measures PM 1.0, PM 2.5 and PM 10.0. It visualises the PM 2.5 data on the device itself, and offloads data using Bluetooth Low Energy to a free IOT cloud service, Adafruit IO via a connected smartphone. It also mounts securely on bicycle handlebars, while allowing for regular dismounting to prevent theft and damage. Please see the following steps for reproducing the device.

## Documentation

The development is broken up into a series of increasingly complex iterations.

### Pre-requisites

Please refer to the following sections in the GitHub ReadMe
- [Items needed](TODO)
- [Software Installation Guide](TODO)

### (Optional) Arduino UNO Wifi Rev 2-based PM Sensor

It is recommended to start with [pm25Bluetooth](TODO), which utilises an Arduino UNO Wifi Rev 2 microcontroller.

Start by emplacing the components on a breadboard as shown below: [TODO]

The code and additional documentation can be found in the [pm25Bluetooth directory](TODO).

### Blink on the ESP32

This code will test that your ESP32 works properly.

The code for the ESP32 Blink example can be found in the [Blink_ESP32 directory](TODO).

Note that when uploading code to an ESP32, you must hold down the "BOOT" button as it is uploading.

### Visualising PM on the ESP32 using an Adafruit NeoPixel

This example will produce the final circuitry layout for this project.
It involves using an Adafruit NeoPixel LED strip to visualise air quality, with the colour of pixels corresponding to the common style used in Air Quality Index:

Within each Air Quality Index level, more pixels will refer to correspond to worse air quality. This design was inspired by [SODAQ AIR](https://www.kickstarter.com/projects/olliesmeenk/sodaq-air-the-portable-air-quality-monitor).

Follow the following steps:

1. As a NeoPixel is in use in this example, you will need to solder a set of four jumper pins onto its input end.
2. After the NeoPixel has been prepared, you can prototype this version on a breadboard: [TODO]
3. Upload the code in the [PM25_neopixel_esp32](TODO) repository to your ESP32 microcontroller.
4. Build the stripboard-based prototype: [todo]
   *  Solder 14 jumper pins onto the stripboard: [todo]
   *  Solder the ESP32 onto the stripboard: [todo]
   *  Create gaps in the board using a hand drill to prevent short circuiting: [todo]
   *  Add all of the non-soldered components: connect the particulate matter breakout board to the PMS5003 sensor and wire both the header pins and the neopixel using female-female cables: [todo]
   * Test again that the device works as it did on the breadboard. Plug in the ESP32 to a 5V power source (such as a computer's USB port) to test that the Neopixel is still lighting up similarly to how it did in the breadboard prototype.
   * Secure the PMS5003 by wedging it between different header pins. 
   * Insulate the non-illuminating side of the neopixel using electrical tape.
   * Secure the NeoPixel (LEDS faced away) to the copper side of the strip board using transparent tape

### Designing an enclosure for the device

Now that the user has produced a deployable prototype, it is a good time to prototype an enclosure.
1. Plug the prototype into the power bank using a USB cable, and confirm that the NeoPixel LEDs are at least partially lit up.
2. Position the power bank atop the PMS5003.
3. Measure the width, height, and depth of the prototype + power bank, ideally with a digital caliper for added precision.
4. Add 3 mm to each dimension to ensure adequate space is available and note these dimensions for the inside of a 3d-printed box. Add another 2 mm for the dimensions of the outside of the box.
5. [Design a box in Fusion 360](https://www.youtube.com/watch?v=HDJ2g19SlCI)
6. [Make one side meshed to allow air to flow into the Plantower](https://www.youtube.com/watch?v=Kj6h6ARtITE&t=176s). This side will be faced towards the cyclist to reduce distortion induced by the PMS5003's fan.
7. 3D Print this box, and ensure that your powered device fits inside of it with the power bank closest to the opening.
8. If the device fits in the box, take measurements for your mount. The mount I printed in this project has three points of support: one at the middle of the stem, and two on the handlebar. A gap needs to be left for the stem's handlebar mount. Take the following measurements:
   * Length and width of the stem's handlebar mount
   * Height difference between the top of the handlebar mount and the tops of both stem and the handlebar at its lowest point (if your handlebar has curvature). Note down whichever height difference is greater.
   * Width of the stem at the approximate point of support
   * Width of the handlebar at the approximate points of support
9.  Return to your 3D Modelling software and produce the base with the following considerations:
    * To fit the boxed device securely, the base will need a .3 mm larger width and length than that of the outer dimensions of the box
    * Vault the edges of the supports slightly for added stability
    * Create a hole within each of the three supports to fit cable ties to create three supports in two axes of rotation
10. Once the base is fully printed, it can be mounted on the bicycle with the cable ties.
11. Carefully place the box upside-down on the mount, preventing the contents from falling out
12. Rubber bands were additionally used during test rides to secure the mount to the base.

### (Optional) Logging runtime using the ESP32 EEPROM memory
[pm25_neopixel_esp32_eeprom](TODO) adds in time-logging: by writing to the EEPROM (electrically erasable programmable read only memory). As this memory is non-volatile, its data will be conserved between power outages. My intention was in particular to use it to test out the longevity of the device: as it constantly

1. [pm25Bluetooth](TODO): Arduino WiFiRev2-based device for a more beginner-friendly prototype. This iteration can be skipped if you only have an ESP32 board.
2. [Blink_ESP32](TODO): to get acquainted with the deployment of code to an ESP32
3. [pm25_neopixel_esp32](TODO): visualise air pollution data using the ESP32 device
4. [pm25_neopixel_esp32_eeprom](TODO): incorporate logging to assess battery life
5.  [pm25_neopixel_esp32_bt_eeprom](TODO): add in BLE to ESP32 model for sending data to AdafruitIO

Please refer to the self-titled directories (linked) on GitHub for detailed documentation on the software.
One breadboard prototype can be used for the Arduino WiFiRev2-based example, and a second breadboard prototype can be used for the latter four ESP32 examples.

### Breadboard Prototypes

#### Arduino WiFi Rev2

This breadboard prototype is straightforward. Ensure that the RX pin on the PM breakout board is connected to the pin used for RX on the Arduino WiFi Rev2.

#### ESP32



Note that two aligned breadboards may be necessary due to the ESP32's width.

Once the user has gotten `pm25_neopixel_esp32` running properly, they are ready to create a soldered stripboard-based prototype.

### ESP32: neopixel-based visualisation

To provide on-bike visualisation of air quality, I needed to use a visual system that required little attention from the user, allowing to glean the necessary information with a quick glance. The method I chose for this project was an LED neopixel strip, with pixel increases indicating slightly worse air quality and a resetting to a different pixel colour with only one pixel shown after the strip was fully lit up. For example, if PM concentrations started at 0 and gradually increased, the strip would gradually show an additional pixel until the bar was filled up with green pixels, after which point it would show one yellow pixel, this time filling up with yellow pixels. This design was inspired by [SODAQ](todo). [TODO: also shorten section through code referencing]


#### Breadboard prototype

The script `pm25_neopixel_esp32` can be found in the [pm25_neopixel_esp32 directory](TODO), and uploaded to the user's ESP32 without changes.


### Design of an enclosure and mount

Plug in the device to a wireless power bank, with the power bank placed atop the PM Sensor. Measure the bundle's depth, width, and height. Add an extra .6 mm to the three dimensions, and use these dimensions as the internal width, height, and depth of a box designed in a 3D modelling software such as Fusion 360. To ensure that 

### Time-logging 



#### 

## Future Goals
